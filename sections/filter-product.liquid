{% comment %}
  File này hiển thị tất cả sản phẩm trong Shopify store dưới dạng lưới responsive.
  Bao gồm ảnh sản phẩm, tiêu đề, giá, nút "Thêm vào giỏ", phân trang, và lọc theo loại sản phẩm bằng JavaScript với if-else.
  Cập nhật để hiển thị tất cả sản phẩm (lên đến 1000) bằng paginate, sửa lỗi phân trang, và giữ lọc client-side.
{% endcomment %}

{% style %}

/* Products Section */
.products-section {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem 1rem;
}

/* Heading */
.products-section h1 {
  font-size: 2.5rem;
  font-weight: 700;
  text-align: center;
  margin-bottom: 2rem;
  color: #222;
}

/* Debug Info */
.debug-info {
  background: #f8f8f8;
  padding: 1rem;
  border-radius: 8px;
  margin-bottom: 1.5rem;
  font-size: 0.9rem;
  color: #555;
}

/* Filter Buttons */
.products-filter {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  justify-content: center;
  margin-bottom: 2rem;
}

.products-filter__type-button {
  background: #f0f0f0;
  border: 1px solid #ddd;
  border-radius: 20px;
  padding: 0.5rem 1rem;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.products-filter__type-button:hover,
.products-filter__type-button--active {
  background: #007bff;
  color: #fff;
  border-color: #007bff;
}

.products-filter__type-button:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.3);
}

/* Products Grid */
.products-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 1.5rem;
  padding: 0 0.5rem;
}

/* Product Card */
.product-card {
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  overflow: hidden;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.product-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.product-card.hidden {
  display: none;
}

.product-card__image-link {
  display: block;
  width: 100%;
  aspect-ratio: 1 / 1;
  overflow: hidden;
}

.product-card__image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.product-card__content {
  padding: 1rem;
}

.product-card__title {
  font-size: 1.1rem;
  font-weight: 600;
  color: #222;
  text-decoration: none;
  display: block;
  margin-bottom: 0.5rem;
}

.product-card__title:hover {
  color: #007bff;
}

.product-card__price {
  font-size: 1rem;
  color: #e44d26;
  margin-bottom: 0.75rem;
}

.product-card__form {
  display: flex;
  justify-content: center;
}

.product-card__button {
  background: #28a745;
  color: #fff;
  border: none;
  border-radius: 5px;
  padding: 0.5rem 1rem;
  font-size: 0.9rem;
  cursor: pointer;
  transition: background 0.3s ease;
  width: 100%;
  text-align: center;
}

.product-card__button:hover {
  background: #218838;
}

.product-card__button:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
}

/* Pagination */
.pagination {
  display: flex;
  justify-content: center;
  gap: 0.5rem;
  margin-top: 2rem;
}

.pagination__link {
  display: inline-block;
  padding: 0.5rem 1rem;
  background: #f0f0f0;
  border-radius: 5px;
  text-decoration: none;
  color: #333;
  font-size: 0.9rem;
  transition: all 0.3s ease;
}

.pagination__link:hover:not(.pagination__link--disabled) {
  background: #007bff;
  color: #fff;
}

.pagination__link--current {
  background: #007bff;
  color: #fff;
  font-weight: 600;
}

.pagination__link--disabled {
  color: #aaa;
  cursor: not-allowed;
}

/* Error Message */
.error-message {
  text-align: center;
  color: #e44d26;
  font-size: 1rem;
  margin: 2rem 0;
}

/* Responsive Design */
@media (max-width: 768px) {
  .products-section h1 {
    font-size: 2rem;
  }

  .products-grid {
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
  }

  .products-filter__type-button {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
  }

  .product-card__title {
    font-size: 1rem;
  }

  .product-card__price {
    font-size: 0.9rem;
  }

  .product-card__button {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
  }
}

@media (max-width: 480px) {
  .products-section {
    padding: 1rem;
  }

  .products-grid {
    grid-template-columns: 1fr;
  }

  .products-filter {
    gap: 0.3rem;
  }

  .products-filter__type-button {
    padding: 0.3rem 0.6rem;
    font-size: 0.8rem;
  }

  .pagination__link {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
  }
}
{% endstyle %}

<section class="products-section" aria-label="Tất cả sản phẩm">
  <h1>Tất cả sản phẩm</h1>



  <div class="products-grid">
    {% paginate collection.products by 1000 %}
      {% for product in collection.products %}
        <div class="product-card" data-product-type="{{ product.type | handle }}">
          <a href="{{ product.url }}" class="product-card__image-link" aria-label="{{ product.title }}">
            {% if product.featured_image %}
              <img
                src="{{ product.featured_image | image_url: width: 300 }}"
                alt="{{ product.title | escape }}"
                class="product-card__image"
                loading="lazy"
              />
            {% else %}
              <img
                src="{{ 'no-image.svg' | asset_url }}"
                alt="Không có ảnh"
                class="product-card__image"
                loading="lazy"
              />
            {% endif %}
          </a>
          <div class="product-card__content">
            <a href="{{ product.url }}" class="product-card__title">{{ product.title }}</a>
            <div class="product-card__price">
              {% if product.price_varies %}
                Từ {{ product.price_min | money }}
              {% else %}
                {{ product.price | money }}
              {% endif %}
            </div>
            {% form 'product', product, class: 'product-card__form' %}
              <input type="hidden" name="id" value="{{ product.variants.first.id }}">
              <button type="submit" class="product-card__button">Thêm vào giỏ</button>
            {% endform %}
          </div>
        </div>
      {% endfor %}
      {% if collection.products.size == 0 %}
        <p class="error-message">Không tìm thấy sản phẩm nào.</p>
      {% endif %}
    {% endpaginate %}
  </div>

  {% comment %} Phân trang giả lập cho client-side {% endcomment %}
  <nav class="pagination" aria-label="Phân trang" id="pagination">
    <!-- JavaScript sẽ tạo phân trang động -->
  </nav>
</section>

{% javascript %}
document.addEventListener('DOMContentLoaded', function() {
  const filterButtons = document.querySelectorAll('.products-filter__type-button');
  const productCards = document.querySelectorAll('.product-card');
  const paginationContainer = document.getElementById('pagination');
  const itemsPerPage = 12;
  let currentPage = 1;
  let currentFilter = 'all';

  function updatePagination(filteredProducts) {
    const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
    paginationContainer.innerHTML = '';

    if (totalPages <= 1) {
      return; // Không cần phân trang nếu chỉ có 1 trang
    }

    // Nút "Trước"
    const prevLink = document.createElement('a');
    prevLink.href = '#';
    prevLink.className = currentPage > 1 ? 'pagination__link' : 'pagination__link pagination__link--disabled';
    prevLink.textContent = 'Trước';
    prevLink.setAttribute('aria-label', 'Trang trước');
    if (currentPage > 1) {
      prevLink.addEventListener('click', (e) => {
        e.preventDefault();
        currentPage--;
        filterProducts(currentFilter);
      });
    }
    paginationContainer.appendChild(prevLink);

    // Nút số trang
    for (let i = 1; i <= totalPages; i++) {
      const pageLink = document.createElement(i === currentPage ? 'span' : 'a');
      pageLink.className = i === currentPage ? 'pagination__link pagination__link--current' : 'pagination__link';
      pageLink.textContent = i;
      pageLink.setAttribute('aria-label', `Trang ${i}`);
      if (i !== currentPage) {
        pageLink.href = '#';
        pageLink.addEventListener('click', (e) => {
          e.preventDefault();
          currentPage = i;
          filterProducts(currentFilter);
        });
      } else {
        pageLink.setAttribute('aria-current', 'page');
      }
      paginationContainer.appendChild(pageLink);
    }

    // Nút "Sau"
    const nextLink = document.createElement('a');
    nextLink.href = '#';
    nextLink.className = currentPage < totalPages ? 'pagination__link' : 'pagination__link pagination__link--disabled';
    nextLink.textContent = 'Sau';
    nextLink.setAttribute('aria-label', 'Trang sau');
    if (currentPage < totalPages) {
      nextLink.addEventListener('click', (e) => {
        e.preventDefault();
        currentPage++;
        filterProducts(currentFilter);
      });
    }
    paginationContainer.appendChild(nextLink);
  }

  function filterProducts(filterType) {
    currentFilter = filterType; // Lưu filter hiện tại
    const filteredProducts = [];

    // Lọc sản phẩm bằng if-else
    productCards.forEach(card => {
      const productType = card.dataset.productType;
      if (filterType === 'all') {
        filteredProducts.push(card);
      } else if (productType === filterType) {
        filteredProducts.push(card);
      }
    });

    // Ẩn tất cả sản phẩm trước khi hiển thị trang hiện tại
    productCards.forEach(card => {
      card.classList.add('hidden');
    });

    // Hiển thị sản phẩm trong trang hiện tại
    filteredProducts.forEach((card, index) => {
      if (index >= (currentPage - 1) * itemsPerPage && index < currentPage * itemsPerPage) {
        card.classList.remove('hidden');
      }
    });

    // Cập nhật phân trang
    updatePagination(filteredProducts);

    // Xử lý thông báo lỗi
    const existingError = document.querySelector('.products-grid .error-message');
    if (existingError) existingError.remove();
    if (filteredProducts.length === 0) {
      const errorMessage = document.createElement('p');
      errorMessage.className = 'error-message';
      errorMessage.textContent = 'Không tìm thấy sản phẩm cho loại này.';
      document.querySelector('.products-grid').appendChild(errorMessage);
    }
  }

  // Gắn sự kiện cho nút lọc
  filterButtons.forEach(button => {
    button.addEventListener('click', () => {
      filterButtons.forEach(btn => btn.classList.remove('products-filter__type-button--active'));
      button.classList.add('products-filter__type-button--active');
      currentPage = 1; // Reset trang khi lọc
      filterProducts(button.dataset.filterType);
    });
  });

  // Khởi tạo với tất cả sản phẩm
  filterProducts('all');

  // Debug số lượng sản phẩm
  console.log('Tổng số sản phẩm tải được:', productCards.length);
});
{% endjavascript %}

{% schema %}
{
  "name": "Products",
  "settings": [
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    }
  ],
  "presets": [
    {
      "name": "Tất cả sản phẩm",
      "category": "Collection"
    }
  ]
}
{% endschema %}